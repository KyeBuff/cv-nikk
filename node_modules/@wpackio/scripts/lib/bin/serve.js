"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.serve = serve;

var _chalk = _interopRequireDefault(require("chalk"));

var _logSymbols = _interopRequireDefault(require("log-symbols"));

var _ora = _interopRequireDefault(require("ora"));

var _path = _interopRequireDefault(require("path"));

var _getProjectAndServerConfig = require("../config/getProjectAndServerConfig");

var _Server = require("../scripts/Server");

var _utils = require("./utils");

var _devUtils = require("../dev-utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/* eslint-disable no-lonely-if */

/* eslint-disable @typescript-eslint/no-var-requires */

/**
 * Start the `wpackio-scripts serve` command.
 *
 * @param options Options as received from CLI.
 */
function serve(options) {
  // Set process.env.NODE_ENV to development
  process.env.NODE_ENV = 'development'; // Set process.env.BABEL_ENV to development

  process.env.BABEL_ENV = 'development'; // Get project and server config JSONs.

  const cwd = (0, _utils.resolveCWD)(options);

  const relCwd = _path.default.relative(process.cwd(), cwd); // For spinner


  const spinner = (0, _ora.default)({
    text: `starting ${_utils.wpackLogoSmall} development server`,
    spinner: 'dots',
    color: 'yellow',
    discardStdin: false
  });
  console.log(`${_logSymbols.default.success} ${_chalk.default.bold('startup')}: ${_chalk.default.cyan(relCwd === '' ? '.' : relCwd)}`);

  try {
    const {
      projectConfig,
      serverConfig,
      projectConfigPath,
      serverConfigPath
    } = (0, _getProjectAndServerConfig.getProjectAndServerConfig)(cwd, options);
    console.log(`${_logSymbols.default.success} ${_chalk.default.bold('project config')}: ${_chalk.default.cyan(_path.default.relative(cwd, projectConfigPath))}`);
    console.log(`${_logSymbols.default.success} ${_chalk.default.bold('server config')}: ${_chalk.default.cyan(_path.default.relative(cwd, serverConfigPath))}`);
    let entries = [];

    if (options !== null && options !== void 0 && options.entries) {
      console.log(`${_logSymbols.default.info} ${_chalk.default.bold('cli')}: ${_chalk.default.cyan(`starting with selective ${options.entries.length} ${options.entries.length === 1 ? 'entry' : 'entries'}`)}`); // make sure to remove duplicates from the entries before looping

      entries = [...new Set(options.entries)].map(e => {
        let entry = Number.parseInt(e, 10);

        if (Number.isNaN(entry)) {
          entry = projectConfig.files.findIndex(file => file.name === e);

          if (entry === -1) {
            console.log(`${_logSymbols.default.error} ${_chalk.default.bold('cli')}: ${_chalk.default.red(`no entry found for `)}${_chalk.default.bold(_chalk.default.yellow(e))} ${_chalk.default.bold('skipping...')}`);
            return false;
          }

          console.log(`${_logSymbols.default.success} ${_chalk.default.bold('cli')}: ${_chalk.default.green(`entry found for `)}${_chalk.default.bold(_chalk.default.yellow(e))}`);
        } else {
          if (projectConfig.files[entry]) {
            console.log(`${_logSymbols.default.success} ${_chalk.default.bold('cli')}: ${_chalk.default.green(`entry found for ${_chalk.default.bold(e)} is`)} ${_chalk.default.bold(_chalk.default.yellow(projectConfig.files[entry].name))}`);
          } else {
            console.log(`${_logSymbols.default.error} ${_chalk.default.bold('cli')}: ${_chalk.default.red(`no entry found for `)}${_chalk.default.bold(_chalk.default.yellow(e))} ${_chalk.default.bold('skipping...')}`);
            return false;
          }
        }

        return entry;
      }).filter(entry => typeof entry === 'number');
    } else if (projectConfig.files.length > 1) {
      (0, _utils.serveEntryInfo)();
    }

    spinner.start();
    let lastWebpackStat = null; // Start the webpack/browserSync server

    const server = new _Server.Server(projectConfig, serverConfig, cwd, {
      // tslint:disable:no-empty
      invalid: () => {
        (0, _utils.printCompilingMessage)();
      },
      done: () => {
        (0, _utils.printSuccessfullyCompiledMessage)();
      },

      onWatching() {
        (0, _utils.printWatchingMessage)();
      },

      onError: msg => {
        (0, _utils.printErrorHeading)('ERROR');
        msg.errors.forEach(e => {
          console.log(e);
          console.log('');
        });
        (0, _utils.printFailedCompileMEssage)();
      },
      onWarn: msg => {
        (0, _utils.printWarningHeading)('WARNING');
        msg.warnings.forEach(e => {
          console.log(e);
          console.log('');
        });
        (0, _utils.printCompiledWithWarnMessage)();
      },
      onEmit: stats => {
        (0, _utils.printCompileTimeMessages)(stats, lastWebpackStat);
        lastWebpackStat = stats.toJson(_utils.webpackStatToJsonOptions);
      },
      firstCompile: stats => {
        spinner.stop();

        if (!stats) {
          (0, _utils.printSuccessfullyCompiledMessage)();
          return;
        }

        const raw = stats.toJson('verbose');
        const messages = (0, _devUtils.formatWebpackMessages)(raw);
        console.log('');
        (0, _utils.serverInfo)(server.getServerUrl(), server.getBsUiUrl());
        console.log('');

        if (stats.hasErrors()) {
          (0, _utils.printErrorHeading)('ERROR');
          messages.errors.forEach(e => {
            console.log(e);
            console.log('');
          });
          (0, _utils.printFailedCompileMEssage)();
        } else if (stats.hasWarnings()) {
          (0, _utils.printWarningHeading)('WARNING');
          messages.warnings.forEach(e => {
            console.log(e);
            console.log('');
          });
          (0, _utils.printCompiledWithWarnMessage)();
        } else {
          (0, _utils.printSuccessfullyCompiledMessage)();
        }

        (0, _utils.printCompileTimeMessages)(stats, lastWebpackStat);
        lastWebpackStat = stats.toJson(_utils.webpackStatToJsonOptions);
      },

      onBsChange(file) {
        (0, _utils.printGeneralInfoMessage)(`changed: ${_chalk.default.bold(file)}`);
        (0, _utils.printGeneralInfoMessage)('reloading browser');
      },

      onTcStart(name) {
        const msg = `${name ? `[${_chalk.default.green(name)}] ` : ''}waiting for typecheck results...`;
        (0, _utils.printGeneralInfoMessage)(msg);
      },

      onInfo(msg, symbol) {
        (0, _utils.printGeneralInfoMessage)(msg, symbol);
      },

      onTcEnd(messages) {
        const name = messages.name;

        if (messages.errors.length || messages.warnings.length) {
          if (messages.errors.length) {
            (0, _utils.printErrorHeading)(`${name ? `[${name}] ` : ''}TS ERROR`);
            messages.errors.forEach(e => {
              console.log(e);
              console.log('');
            });
          }

          if (messages.warnings.length) {
            (0, _utils.printWarningHeading)(`${name ? `[${name}] ` : ''}TS WARNING`);
            messages.warnings.forEach(e => {
              console.log(e);
              console.log('');
            });
          }
        } else {
          const msg = `${name ? `[${_chalk.default.green(name)}] ` : ''}no typecheck errors`;
          (0, _utils.printGeneralInfoMessage)(msg, _logSymbols.default.success);
        }
      }

    }, entries);
    server.serve();

    const stopServer = () => {
      console.log((0, _utils.addTimeStampToLog)(`${_logSymbols.default.warning} shutting down development server`));
      server.stop();
      console.log('');
      (0, _utils.endServeInfo)();
      console.log('');
      process.exit(0);
    }; // Listen for `r`


    if (process.stdin.setRawMode) {
      process.stdin.setRawMode(true);
      const {
        stdin
      } = process;
      stdin.setEncoding('utf8');
      stdin.on('data', key => {
        // ctrl-c ( end of text )
        // or if pressing q, then stop
        // then stop server
        if (key === '\u0003' || key === 'q') {
          stopServer();
        } // If pressing r, then just refresh


        if (key.indexOf('r') === 0) {
          (0, _utils.printCompilingMessage)();
          server.refresh();
        }
      });
    } else {
      // Listen for SIGINT and quit properly
      process.on('SIGINT', () => {
        stopServer();
      });
    }
  } catch (e) {
    spinner.stop();
    (0, _utils.prettyPrintError)(e, 'could not start server.');
    process.exit(1);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iaW4vc2VydmUudHMiXSwibmFtZXMiOlsic2VydmUiLCJvcHRpb25zIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiQkFCRUxfRU5WIiwiY3dkIiwicmVsQ3dkIiwicGF0aCIsInJlbGF0aXZlIiwic3Bpbm5lciIsInRleHQiLCJ3cGFja0xvZ29TbWFsbCIsImNvbG9yIiwiZGlzY2FyZFN0ZGluIiwiY29uc29sZSIsImxvZyIsImxvZ1N5bWJvbHMiLCJzdWNjZXNzIiwiY2hhbGsiLCJib2xkIiwiY3lhbiIsInByb2plY3RDb25maWciLCJzZXJ2ZXJDb25maWciLCJwcm9qZWN0Q29uZmlnUGF0aCIsInNlcnZlckNvbmZpZ1BhdGgiLCJlbnRyaWVzIiwiaW5mbyIsImxlbmd0aCIsIlNldCIsIm1hcCIsImUiLCJlbnRyeSIsIk51bWJlciIsInBhcnNlSW50IiwiaXNOYU4iLCJmaWxlcyIsImZpbmRJbmRleCIsImZpbGUiLCJuYW1lIiwiZXJyb3IiLCJyZWQiLCJ5ZWxsb3ciLCJncmVlbiIsImZpbHRlciIsInN0YXJ0IiwibGFzdFdlYnBhY2tTdGF0Iiwic2VydmVyIiwiU2VydmVyIiwiaW52YWxpZCIsImRvbmUiLCJvbldhdGNoaW5nIiwib25FcnJvciIsIm1zZyIsImVycm9ycyIsImZvckVhY2giLCJvbldhcm4iLCJ3YXJuaW5ncyIsIm9uRW1pdCIsInN0YXRzIiwidG9Kc29uIiwid2VicGFja1N0YXRUb0pzb25PcHRpb25zIiwiZmlyc3RDb21waWxlIiwic3RvcCIsInJhdyIsIm1lc3NhZ2VzIiwiZ2V0U2VydmVyVXJsIiwiZ2V0QnNVaVVybCIsImhhc0Vycm9ycyIsImhhc1dhcm5pbmdzIiwib25Cc0NoYW5nZSIsIm9uVGNTdGFydCIsIm9uSW5mbyIsInN5bWJvbCIsIm9uVGNFbmQiLCJzdG9wU2VydmVyIiwid2FybmluZyIsImV4aXQiLCJzdGRpbiIsInNldFJhd01vZGUiLCJzZXRFbmNvZGluZyIsIm9uIiwia2V5IiwiaW5kZXhP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QVIsQ0FBWSxFQUFaO0FBQ0E7QUFDQUQsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksRUFBWjtBQUNBZCxNQUFBQSxPQUFPLENBQUMyRSxJQUFSLENBQWEsQ0FBYjtBQUNBLEtBWEQsQ0FwTEcsQ0FpTUg7OztBQUNBLFFBQUkzRSxPQUFPLENBQUM0RSxLQUFSLENBQWNDLFVBQWxCLEVBQThCO0FBQzdCN0UsTUFBQUEsT0FBTyxDQUFDNEUsS0FBUixDQUFjQyxVQUFkLENBQXlCLElBQXpCO0FBQ0EsWUFBTTtBQUFFRCxRQUFBQTtBQUFGLFVBQVk1RSxPQUFsQjtBQUNBNEUsTUFBQUEsS0FBSyxDQUFDRSxXQUFOLENBQWtCLE1BQWxCO0FBQ0FGLE1BQUFBLEtBQUssQ0FBQ0csRUFBTixDQUFTLE1BQVQsRUFBa0JDLEdBQUQsSUFBaUI7QUFDakM7QUFDQTtBQUNBO0FBQ0EsWUFBSUEsR0FBRyxLQUFLLFFBQVIsSUFBb0JBLEdBQUcsS0FBSyxHQUFoQyxFQUFxQztBQUNwQ1AsVUFBQUEsVUFBVTtBQUNWLFNBTmdDLENBUWpDOzs7QUFDQSxZQUFJTyxHQUFHLENBQUNDLE9BQUosQ0FBWSxHQUFaLE1BQXFCLENBQXpCLEVBQTRCO0FBQzNCO0FBQ0FwQyxVQUFBQSxNQUFNLENBQUNxQyxPQUFQO0FBQ0E7QUFDRCxPQWJEO0FBY0EsS0FsQkQsTUFrQk87QUFDTjtBQUNBbEYsTUFBQUEsT0FBTyxDQUFDK0UsRUFBUixDQUFXLFFBQVgsRUFBcUIsTUFBTTtBQUMxQk4sUUFBQUEsVUFBVTtBQUNWLE9BRkQ7QUFHQTtBQUNELEdBMU5ELENBME5FLE9BQU81QyxDQUFQLEVBQVU7QUFDWHJCLElBQUFBLE9BQU8sQ0FBQ3FELElBQVI7QUFDQSxpQ0FBaUJoQyxDQUFqQixFQUFvQix5QkFBcEI7QUFDQTdCLElBQUFBLE9BQU8sQ0FBQzJFLElBQVIsQ0FBYSxDQUFiO0FBQ0E7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLWxvbmVseS1pZiAqL1xuLyogZXNsaW50LWRpc2FibGUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlcyAqL1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBsb2dTeW1ib2xzIGZyb20gJ2xvZy1zeW1ib2xzJztcbmltcG9ydCBvcmEgZnJvbSAnb3JhJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHdlYnBhY2sgZnJvbSAnd2VicGFjayc7XG5pbXBvcnQgeyBnZXRQcm9qZWN0QW5kU2VydmVyQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnL2dldFByb2plY3RBbmRTZXJ2ZXJDb25maWcnO1xuaW1wb3J0IHsgU2VydmVyIH0gZnJvbSAnLi4vc2NyaXB0cy9TZXJ2ZXInO1xuaW1wb3J0IHsgUHJvZ3JhbU9wdGlvbnMgfSBmcm9tICcuL2luZGV4JztcbmltcG9ydCB7XG5cdGVuZFNlcnZlSW5mbyxcblx0cHJldHR5UHJpbnRFcnJvcixcblx0cmVzb2x2ZUNXRCxcblx0c2VydmVySW5mbyxcblx0d3BhY2tMb2dvU21hbGwsXG5cdHByaW50V2F0Y2hpbmdNZXNzYWdlLFxuXHRhZGRUaW1lU3RhbXBUb0xvZyxcblx0cHJpbnRDb21waWxpbmdNZXNzYWdlLFxuXHRwcmludFN1Y2Nlc3NmdWxseUNvbXBpbGVkTWVzc2FnZSxcblx0cHJpbnRDb21waWxlZFdpdGhXYXJuTWVzc2FnZSxcblx0cHJpbnRGYWlsZWRDb21waWxlTUVzc2FnZSxcblx0cHJpbnRHZW5lcmFsSW5mb01lc3NhZ2UsXG5cdHByaW50Q29tcGlsZVRpbWVNZXNzYWdlcyxcblx0d2VicGFja1N0YXRUb0pzb25PcHRpb25zLFxuXHRwcmludEVycm9ySGVhZGluZyxcblx0cHJpbnRXYXJuaW5nSGVhZGluZyxcblx0c2VydmVFbnRyeUluZm8sXG59IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgZm9ybWF0V2VicGFja01lc3NhZ2VzIH0gZnJvbSAnLi4vZGV2LXV0aWxzJztcblxuLyoqXG4gKiBTdGFydCB0aGUgYHdwYWNraW8tc2NyaXB0cyBzZXJ2ZWAgY29tbWFuZC5cbiAqXG4gKiBAcGFyYW0gb3B0aW9ucyBPcHRpb25zIGFzIHJlY2VpdmVkIGZyb20gQ0xJLlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2VydmUob3B0aW9uczogUHJvZ3JhbU9wdGlvbnMgfCB1bmRlZmluZWQpOiB2b2lkIHtcblx0Ly8gU2V0IHByb2Nlc3MuZW52Lk5PREVfRU5WIHRvIGRldmVsb3BtZW50XG5cdHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ2RldmVsb3BtZW50Jztcblx0Ly8gU2V0IHByb2Nlc3MuZW52LkJBQkVMX0VOViB0byBkZXZlbG9wbWVudFxuXHRwcm9jZXNzLmVudi5CQUJFTF9FTlYgPSAnZGV2ZWxvcG1lbnQnO1xuXHQvLyBHZXQgcHJvamVjdCBhbmQgc2VydmVyIGNvbmZpZyBKU09Ocy5cblx0Y29uc3QgY3dkID0gcmVzb2x2ZUNXRChvcHRpb25zKTtcblx0Y29uc3QgcmVsQ3dkID0gcGF0aC5yZWxhdGl2ZShwcm9jZXNzLmN3ZCgpLCBjd2QpO1xuXG5cdC8vIEZvciBzcGlubmVyXG5cdGNvbnN0IHNwaW5uZXIgPSBvcmEoe1xuXHRcdHRleHQ6IGBzdGFydGluZyAke3dwYWNrTG9nb1NtYWxsfSBkZXZlbG9wbWVudCBzZXJ2ZXJgLFxuXHRcdHNwaW5uZXI6ICdkb3RzJyxcblx0XHRjb2xvcjogJ3llbGxvdycsXG5cdFx0ZGlzY2FyZFN0ZGluOiBmYWxzZSxcblx0fSk7XG5cblx0Y29uc29sZS5sb2coXG5cdFx0YCR7bG9nU3ltYm9scy5zdWNjZXNzfSAke2NoYWxrLmJvbGQoJ3N0YXJ0dXAnKX06ICR7Y2hhbGsuY3lhbihcblx0XHRcdHJlbEN3ZCA9PT0gJycgPyAnLicgOiByZWxDd2Rcblx0XHQpfWBcblx0KTtcblx0dHJ5IHtcblx0XHRjb25zdCB7IHByb2plY3RDb25maWcsIHNlcnZlckNvbmZpZywgcHJvamVjdENvbmZpZ1BhdGgsIHNlcnZlckNvbmZpZ1BhdGggfSA9XG5cdFx0XHRnZXRQcm9qZWN0QW5kU2VydmVyQ29uZmlnKGN3ZCwgb3B0aW9ucyk7XG5cdFx0Y29uc29sZS5sb2coXG5cdFx0XHRgJHtsb2dTeW1ib2xzLnN1Y2Nlc3N9ICR7Y2hhbGsuYm9sZCgncHJvamVjdCBjb25maWcnKX06ICR7Y2hhbGsuY3lhbihcblx0XHRcdFx0cGF0aC5yZWxhdGl2ZShjd2QsIHByb2plY3RDb25maWdQYXRoKVxuXHRcdFx0KX1gXG5cdFx0KTtcblx0XHRjb25zb2xlLmxvZyhcblx0XHRcdGAke2xvZ1N5bWJvbHMuc3VjY2Vzc30gJHtjaGFsay5ib2xkKCdzZXJ2ZXIgY29uZmlnJyl9OiAke2NoYWxrLmN5YW4oXG5cdFx0XHRcdHBhdGgucmVsYXRpdmUoY3dkLCBzZXJ2ZXJDb25maWdQYXRoKVxuXHRcdFx0KX1gXG5cdFx0KTtcblxuXHRcdGxldCBlbnRyaWVzOiBudW1iZXJbXSA9IFtdO1xuXG5cdFx0aWYgKG9wdGlvbnM/LmVudHJpZXMpIHtcblx0XHRcdGNvbnNvbGUubG9nKFxuXHRcdFx0XHRgJHtsb2dTeW1ib2xzLmluZm99ICR7Y2hhbGsuYm9sZCgnY2xpJyl9OiAke2NoYWxrLmN5YW4oXG5cdFx0XHRcdFx0YHN0YXJ0aW5nIHdpdGggc2VsZWN0aXZlICR7b3B0aW9ucy5lbnRyaWVzLmxlbmd0aH0gJHtcblx0XHRcdFx0XHRcdG9wdGlvbnMuZW50cmllcy5sZW5ndGggPT09IDEgPyAnZW50cnknIDogJ2VudHJpZXMnXG5cdFx0XHRcdFx0fWBcblx0XHRcdFx0KX1gXG5cdFx0XHQpO1xuXHRcdFx0Ly8gbWFrZSBzdXJlIHRvIHJlbW92ZSBkdXBsaWNhdGVzIGZyb20gdGhlIGVudHJpZXMgYmVmb3JlIGxvb3Bpbmdcblx0XHRcdGVudHJpZXMgPSBbLi4ubmV3IFNldChvcHRpb25zLmVudHJpZXMpXVxuXHRcdFx0XHQubWFwKGUgPT4ge1xuXHRcdFx0XHRcdGxldCBlbnRyeSA9IE51bWJlci5wYXJzZUludChlLCAxMCk7XG5cdFx0XHRcdFx0aWYgKE51bWJlci5pc05hTihlbnRyeSkpIHtcblx0XHRcdFx0XHRcdGVudHJ5ID0gcHJvamVjdENvbmZpZy5maWxlcy5maW5kSW5kZXgoZmlsZSA9PiBmaWxlLm5hbWUgPT09IGUpO1xuXHRcdFx0XHRcdFx0aWYgKGVudHJ5ID09PSAtMSkge1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhcblx0XHRcdFx0XHRcdFx0XHRgJHtsb2dTeW1ib2xzLmVycm9yfSAke2NoYWxrLmJvbGQoJ2NsaScpfTogJHtjaGFsay5yZWQoXG5cdFx0XHRcdFx0XHRcdFx0XHRgbm8gZW50cnkgZm91bmQgZm9yIGBcblx0XHRcdFx0XHRcdFx0XHQpfSR7Y2hhbGsuYm9sZChjaGFsay55ZWxsb3coZSkpfSAke2NoYWxrLmJvbGQoJ3NraXBwaW5nLi4uJyl9YFxuXHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhcblx0XHRcdFx0XHRcdFx0YCR7bG9nU3ltYm9scy5zdWNjZXNzfSAke2NoYWxrLmJvbGQoJ2NsaScpfTogJHtjaGFsay5ncmVlbihcblx0XHRcdFx0XHRcdFx0XHRgZW50cnkgZm91bmQgZm9yIGBcblx0XHRcdFx0XHRcdFx0KX0ke2NoYWxrLmJvbGQoY2hhbGsueWVsbG93KGUpKX1gXG5cdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRpZiAocHJvamVjdENvbmZpZy5maWxlc1tlbnRyeV0pIHtcblx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coXG5cdFx0XHRcdFx0XHRcdFx0YCR7bG9nU3ltYm9scy5zdWNjZXNzfSAke2NoYWxrLmJvbGQoJ2NsaScpfTogJHtjaGFsay5ncmVlbihcblx0XHRcdFx0XHRcdFx0XHRcdGBlbnRyeSBmb3VuZCBmb3IgJHtjaGFsay5ib2xkKGUpfSBpc2Bcblx0XHRcdFx0XHRcdFx0XHQpfSAke2NoYWxrLmJvbGQoY2hhbGsueWVsbG93KHByb2plY3RDb25maWcuZmlsZXNbZW50cnldLm5hbWUpKX1gXG5cdFx0XHRcdFx0XHRcdCk7XG5cdFx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhcblx0XHRcdFx0XHRcdFx0XHRgJHtsb2dTeW1ib2xzLmVycm9yfSAke2NoYWxrLmJvbGQoJ2NsaScpfTogJHtjaGFsay5yZWQoXG5cdFx0XHRcdFx0XHRcdFx0XHRgbm8gZW50cnkgZm91bmQgZm9yIGBcblx0XHRcdFx0XHRcdFx0XHQpfSR7Y2hhbGsuYm9sZChjaGFsay55ZWxsb3coZSkpfSAke2NoYWxrLmJvbGQoJ3NraXBwaW5nLi4uJyl9YFxuXHRcdFx0XHRcdFx0XHQpO1xuXHRcdFx0XHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHRcdHJldHVybiBlbnRyeTtcblx0XHRcdFx0fSlcblx0XHRcdFx0LmZpbHRlcihlbnRyeSA9PiB0eXBlb2YgZW50cnkgPT09ICdudW1iZXInKSBhcyBudW1iZXJbXTtcblx0XHR9IGVsc2UgaWYgKHByb2plY3RDb25maWcuZmlsZXMubGVuZ3RoID4gMSkge1xuXHRcdFx0c2VydmVFbnRyeUluZm8oKTtcblx0XHR9XG5cblx0XHRzcGlubmVyLnN0YXJ0KCk7XG5cblx0XHRsZXQgbGFzdFdlYnBhY2tTdGF0OiBhbnkgfCBudWxsID0gbnVsbDtcblxuXHRcdC8vIFN0YXJ0IHRoZSB3ZWJwYWNrL2Jyb3dzZXJTeW5jIHNlcnZlclxuXHRcdGNvbnN0IHNlcnZlcjogU2VydmVyID0gbmV3IFNlcnZlcihcblx0XHRcdHByb2plY3RDb25maWcsXG5cdFx0XHRzZXJ2ZXJDb25maWcsXG5cdFx0XHRjd2QsXG5cdFx0XHR7XG5cdFx0XHRcdC8vIHRzbGludDpkaXNhYmxlOm5vLWVtcHR5XG5cdFx0XHRcdGludmFsaWQ6ICgpID0+IHtcblx0XHRcdFx0XHRwcmludENvbXBpbGluZ01lc3NhZ2UoKTtcblx0XHRcdFx0fSxcblx0XHRcdFx0ZG9uZTogKCkgPT4ge1xuXHRcdFx0XHRcdHByaW50U3VjY2Vzc2Z1bGx5Q29tcGlsZWRNZXNzYWdlKCk7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdG9uV2F0Y2hpbmcoKSB7XG5cdFx0XHRcdFx0cHJpbnRXYXRjaGluZ01lc3NhZ2UoKTtcblx0XHRcdFx0fSxcblx0XHRcdFx0b25FcnJvcjogbXNnID0+IHtcblx0XHRcdFx0XHRwcmludEVycm9ySGVhZGluZygnRVJST1InKTtcblx0XHRcdFx0XHRtc2cuZXJyb3JzLmZvckVhY2goZSA9PiB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhlKTtcblx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCcnKTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRwcmludEZhaWxlZENvbXBpbGVNRXNzYWdlKCk7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdG9uV2FybjogbXNnID0+IHtcblx0XHRcdFx0XHRwcmludFdhcm5pbmdIZWFkaW5nKCdXQVJOSU5HJyk7XG5cdFx0XHRcdFx0bXNnLndhcm5pbmdzLmZvckVhY2goZSA9PiB7XG5cdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhlKTtcblx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCcnKTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRwcmludENvbXBpbGVkV2l0aFdhcm5NZXNzYWdlKCk7XG5cdFx0XHRcdH0sXG5cdFx0XHRcdG9uRW1pdDogc3RhdHMgPT4ge1xuXHRcdFx0XHRcdHByaW50Q29tcGlsZVRpbWVNZXNzYWdlcyhzdGF0cywgbGFzdFdlYnBhY2tTdGF0KTtcblx0XHRcdFx0XHRsYXN0V2VicGFja1N0YXQgPSBzdGF0cy50b0pzb24od2VicGFja1N0YXRUb0pzb25PcHRpb25zKTtcblx0XHRcdFx0fSxcblx0XHRcdFx0Zmlyc3RDb21waWxlOiAoc3RhdHM6IHdlYnBhY2suU3RhdHMgfCB1bmRlZmluZWQpID0+IHtcblx0XHRcdFx0XHRzcGlubmVyLnN0b3AoKTtcblx0XHRcdFx0XHRpZiAoIXN0YXRzKSB7XG5cdFx0XHRcdFx0XHRwcmludFN1Y2Nlc3NmdWxseUNvbXBpbGVkTWVzc2FnZSgpO1xuXHRcdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0XHRjb25zdCByYXcgPSBzdGF0cy50b0pzb24oJ3ZlcmJvc2UnKTtcblx0XHRcdFx0XHRjb25zdCBtZXNzYWdlcyA9IGZvcm1hdFdlYnBhY2tNZXNzYWdlcyhyYXcpO1xuXHRcdFx0XHRcdGNvbnNvbGUubG9nKCcnKTtcblx0XHRcdFx0XHRzZXJ2ZXJJbmZvKHNlcnZlci5nZXRTZXJ2ZXJVcmwoKSwgc2VydmVyLmdldEJzVWlVcmwoKSk7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coJycpO1xuXG5cdFx0XHRcdFx0aWYgKHN0YXRzLmhhc0Vycm9ycygpKSB7XG5cdFx0XHRcdFx0XHRwcmludEVycm9ySGVhZGluZygnRVJST1InKTtcblx0XHRcdFx0XHRcdG1lc3NhZ2VzLmVycm9ycy5mb3JFYWNoKChlOiBzdHJpbmcpID0+IHtcblx0XHRcdFx0XHRcdFx0Y29uc29sZS5sb2coZSk7XG5cdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCcnKTtcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0cHJpbnRGYWlsZWRDb21waWxlTUVzc2FnZSgpO1xuXHRcdFx0XHRcdH0gZWxzZSBpZiAoc3RhdHMuaGFzV2FybmluZ3MoKSkge1xuXHRcdFx0XHRcdFx0cHJpbnRXYXJuaW5nSGVhZGluZygnV0FSTklORycpO1xuXHRcdFx0XHRcdFx0bWVzc2FnZXMud2FybmluZ3MuZm9yRWFjaCgoZTogc3RyaW5nKSA9PiB7XG5cdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKGUpO1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZygnJyk7XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdHByaW50Q29tcGlsZWRXaXRoV2Fybk1lc3NhZ2UoKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0cHJpbnRTdWNjZXNzZnVsbHlDb21waWxlZE1lc3NhZ2UoKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0cHJpbnRDb21waWxlVGltZU1lc3NhZ2VzKHN0YXRzLCBsYXN0V2VicGFja1N0YXQpO1xuXHRcdFx0XHRcdGxhc3RXZWJwYWNrU3RhdCA9IHN0YXRzLnRvSnNvbih3ZWJwYWNrU3RhdFRvSnNvbk9wdGlvbnMpO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRvbkJzQ2hhbmdlKGZpbGUpIHtcblx0XHRcdFx0XHRwcmludEdlbmVyYWxJbmZvTWVzc2FnZShgY2hhbmdlZDogJHtjaGFsay5ib2xkKGZpbGUpfWApO1xuXHRcdFx0XHRcdHByaW50R2VuZXJhbEluZm9NZXNzYWdlKCdyZWxvYWRpbmcgYnJvd3NlcicpO1xuXHRcdFx0XHR9LFxuXHRcdFx0XHRvblRjU3RhcnQobmFtZSkge1xuXHRcdFx0XHRcdGNvbnN0IG1zZyA9IGAke1xuXHRcdFx0XHRcdFx0bmFtZSA/IGBbJHtjaGFsay5ncmVlbihuYW1lKX1dIGAgOiAnJ1xuXHRcdFx0XHRcdH13YWl0aW5nIGZvciB0eXBlY2hlY2sgcmVzdWx0cy4uLmA7XG5cdFx0XHRcdFx0cHJpbnRHZW5lcmFsSW5mb01lc3NhZ2UobXNnKTtcblx0XHRcdFx0fSxcblx0XHRcdFx0b25JbmZvKG1zZzogc3RyaW5nLCBzeW1ib2w6IHN0cmluZykge1xuXHRcdFx0XHRcdHByaW50R2VuZXJhbEluZm9NZXNzYWdlKG1zZywgc3ltYm9sKTtcblx0XHRcdFx0fSxcblx0XHRcdFx0b25UY0VuZChtZXNzYWdlcykge1xuXHRcdFx0XHRcdGNvbnN0IG5hbWUgPSBtZXNzYWdlcy5uYW1lO1xuXHRcdFx0XHRcdGlmIChtZXNzYWdlcy5lcnJvcnMubGVuZ3RoIHx8IG1lc3NhZ2VzLndhcm5pbmdzLmxlbmd0aCkge1xuXHRcdFx0XHRcdFx0aWYgKG1lc3NhZ2VzLmVycm9ycy5sZW5ndGgpIHtcblx0XHRcdFx0XHRcdFx0cHJpbnRFcnJvckhlYWRpbmcoYCR7bmFtZSA/IGBbJHtuYW1lfV0gYCA6ICcnfVRTIEVSUk9SYCk7XG5cdFx0XHRcdFx0XHRcdG1lc3NhZ2VzLmVycm9ycy5mb3JFYWNoKGUgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKGUpO1xuXHRcdFx0XHRcdFx0XHRcdGNvbnNvbGUubG9nKCcnKTtcblx0XHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRpZiAobWVzc2FnZXMud2FybmluZ3MubGVuZ3RoKSB7XG5cdFx0XHRcdFx0XHRcdHByaW50V2FybmluZ0hlYWRpbmcoYCR7bmFtZSA/IGBbJHtuYW1lfV0gYCA6ICcnfVRTIFdBUk5JTkdgKTtcblx0XHRcdFx0XHRcdFx0bWVzc2FnZXMud2FybmluZ3MuZm9yRWFjaChlID0+IHtcblx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhlKTtcblx0XHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZygnJyk7XG5cdFx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zdCBtc2cgPSBgJHtcblx0XHRcdFx0XHRcdFx0bmFtZSA/IGBbJHtjaGFsay5ncmVlbihuYW1lKX1dIGAgOiAnJ1xuXHRcdFx0XHRcdFx0fW5vIHR5cGVjaGVjayBlcnJvcnNgO1xuXHRcdFx0XHRcdFx0cHJpbnRHZW5lcmFsSW5mb01lc3NhZ2UobXNnLCBsb2dTeW1ib2xzLnN1Y2Nlc3MpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSxcblx0XHRcdH0sXG5cdFx0XHRlbnRyaWVzXG5cdFx0KTtcblx0XHRzZXJ2ZXIuc2VydmUoKTtcblxuXHRcdGNvbnN0IHN0b3BTZXJ2ZXIgPSAoKSA9PiB7XG5cdFx0XHRjb25zb2xlLmxvZyhcblx0XHRcdFx0YWRkVGltZVN0YW1wVG9Mb2coXG5cdFx0XHRcdFx0YCR7bG9nU3ltYm9scy53YXJuaW5nfSBzaHV0dGluZyBkb3duIGRldmVsb3BtZW50IHNlcnZlcmBcblx0XHRcdFx0KVxuXHRcdFx0KTtcblx0XHRcdHNlcnZlci5zdG9wKCk7XG5cdFx0XHRjb25zb2xlLmxvZygnJyk7XG5cdFx0XHRlbmRTZXJ2ZUluZm8oKTtcblx0XHRcdGNvbnNvbGUubG9nKCcnKTtcblx0XHRcdHByb2Nlc3MuZXhpdCgwKTtcblx0XHR9O1xuXG5cdFx0Ly8gTGlzdGVuIGZvciBgcmBcblx0XHRpZiAocHJvY2Vzcy5zdGRpbi5zZXRSYXdNb2RlKSB7XG5cdFx0XHRwcm9jZXNzLnN0ZGluLnNldFJhd01vZGUodHJ1ZSk7XG5cdFx0XHRjb25zdCB7IHN0ZGluIH0gPSBwcm9jZXNzO1xuXHRcdFx0c3RkaW4uc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcblx0XHRcdHN0ZGluLm9uKCdkYXRhJywgKGtleTogc3RyaW5nKSA9PiB7XG5cdFx0XHRcdC8vIGN0cmwtYyAoIGVuZCBvZiB0ZXh0IClcblx0XHRcdFx0Ly8gb3IgaWYgcHJlc3NpbmcgcSwgdGhlbiBzdG9wXG5cdFx0XHRcdC8vIHRoZW4gc3RvcCBzZXJ2ZXJcblx0XHRcdFx0aWYgKGtleSA9PT0gJ1xcdTAwMDMnIHx8IGtleSA9PT0gJ3EnKSB7XG5cdFx0XHRcdFx0c3RvcFNlcnZlcigpO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0Ly8gSWYgcHJlc3NpbmcgciwgdGhlbiBqdXN0IHJlZnJlc2hcblx0XHRcdFx0aWYgKGtleS5pbmRleE9mKCdyJykgPT09IDApIHtcblx0XHRcdFx0XHRwcmludENvbXBpbGluZ01lc3NhZ2UoKTtcblx0XHRcdFx0XHRzZXJ2ZXIucmVmcmVzaCgpO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Ly8gTGlzdGVuIGZvciBTSUdJTlQgYW5kIHF1aXQgcHJvcGVybHlcblx0XHRcdHByb2Nlc3Mub24oJ1NJR0lOVCcsICgpID0+IHtcblx0XHRcdFx0c3RvcFNlcnZlcigpO1xuXHRcdFx0fSk7XG5cdFx0fVxuXHR9IGNhdGNoIChlKSB7XG5cdFx0c3Bpbm5lci5zdG9wKCk7XG5cdFx0cHJldHR5UHJpbnRFcnJvcihlLCAnY291bGQgbm90IHN0YXJ0IHNlcnZlci4nKTtcblx0XHRwcm9jZXNzLmV4aXQoMSk7XG5cdH1cbn1cbiJdfQ==
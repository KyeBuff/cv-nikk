"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validateProjectConfig = validateProjectConfig;
exports.validateServerConfig = validateServerConfig;
exports.getProjectConfig = getProjectConfig;
exports.getServerConfig = getServerConfig;
exports.getProjectAndServerConfig = getProjectAndServerConfig;

var _camelcase = _interopRequireDefault(require("camelcase"));

var _chalk = _interopRequireDefault(require("chalk"));

var _path = _interopRequireDefault(require("path"));

var _utils = require("../bin/utils");

var _WpackioError = require("../errors/WpackioError");

var _projectConfig = require("./project.config.default");

var _serverConfig = require("./server.config.default");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function validateProjectConfig(projectConfig) {
  if (typeof projectConfig !== 'object') {
    throw new _WpackioError.WpackioError(`Project configuration must export an object literal.\nRight now it is ${_chalk.default.yellow(typeof projectConfig)}`);
  } // Check if the appName is okay


  if (!projectConfig.appName) {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('appName')} must be present in project config.`);
  }

  if (!/^[A-Za-z]+$/.test(projectConfig.appName)) {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('appName')} must be in camelCase in project config.\nCurrently ${_chalk.default.red(projectConfig.appName)}, try ${_chalk.default.green((0, _camelcase.default)(projectConfig.appName))}`);
  } // validate runtime config
  // 1. if files is invalid


  if (!projectConfig.files || !Array.isArray(projectConfig.files)) {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('files')} under project configuration must be an array.\nCurrently it is ${_chalk.default.red(typeof projectConfig.files)}`);
  } // 2. if files is empty


  if (projectConfig.files.length === 0) {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('files')} under project configuration must have at-least one object.`);
  } // 3. validate files array


  if (!projectConfig.files.every(file => typeof file === 'object' && file.name != null && file.entry != null)) {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('files')} under project configuration must have objects with\n${_chalk.default.magenta('name')} and ${_chalk.default.magenta('entry')}.\nAt-least one of the objects does not satisfy the condition.`);
  } // 4. Validate package configs


  if (!projectConfig.packageDirPath || projectConfig.packageDirPath === '') {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('packageDirPath')} under project configuration must be valid.\nIt defines the path to package output directory.`);
  }

  if (!projectConfig.packageFiles || !Array.isArray(projectConfig.packageFiles) || !projectConfig.packageFiles.length || !projectConfig.packageFiles.every(f => typeof f === 'string')) {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('packageFiles')} under project configuration must be valid glob patterns.`);
  }

  return true;
}

function validateServerConfig(serverConfig) {
  if (typeof serverConfig !== 'object') {
    throw new _WpackioError.WpackioError(`Server configuration must export an object literal.\nRight now it is ${_chalk.default.yellow(typeof serverConfig)}`);
  } // Check if server config has proxy


  if (!serverConfig.proxy || serverConfig.proxy === '') {
    throw new _WpackioError.WpackioError(`${_chalk.default.yellow('proxy')} under server configuration must be an URL to your development server.`);
  }

  return true;
}

function getProjectConfig(cwd, options) {
  const projectConfigPath = _path.default.resolve(cwd, options && options.projectConfig ? options.projectConfig : 'wpackio.project.js');

  let projectConfig; // First check to see if the files are present

  try {
    // eslint-disable-next-line global-require, @typescript-eslint/no-var-requires
    projectConfig = require(projectConfigPath);
  } catch (e) {
    throw new _WpackioError.WpackioError(`Could not find project configuration at:\n${_chalk.default.dim(projectConfigPath)}\nPlease make sure the file exists\nor adjust your ${_chalk.default.yellow('--context')} or ${_chalk.default.yellow('--project-config')} parameters.\nIf this is your first time, try running\n${_chalk.default.magenta(`${(0, _utils.isYarn)() ? 'yarn' : 'npm run'} bootstrap`)}`);
  } // Now validate them


  validateProjectConfig(projectConfig);
  return {
    projectConfig: _objectSpread(_objectSpread({}, _projectConfig.projectConfigDefault), projectConfig),
    projectConfigPath
  };
}

function getServerConfig(cwd, options) {
  // Get the config file paths from options
  // If user is passing relative path, then it will be used along with cwd
  // If it is absolute path, then the absolute would be used instead
  // This is how path.resolve works.
  const serverConfigPath = _path.default.resolve(cwd, options && options.serverConfig ? options.serverConfig : 'wpackio.server.js'); // Now create the configuration objects


  let serverConfig;

  try {
    // eslint-disable-next-line global-require, @typescript-eslint/no-var-requires
    serverConfig = require(serverConfigPath);
  } catch (e) {
    throw new _WpackioError.WpackioError(`Could not find server configuration at:\n${_chalk.default.dim(serverConfigPath)}\nPlease make sure the file exists\nor adjust your ${_chalk.default.yellow('--context')} or ${_chalk.default.yellow('--server-config')} parameters.\nIf this is your first time, try running\n${_chalk.default.magenta(`${(0, _utils.isYarn)() ? 'yarn' : 'npm run'} bootstrap`)}`);
  } // Validate them


  validateServerConfig(serverConfig);
  return {
    serverConfig: _objectSpread(_objectSpread({}, _serverConfig.serverConfigDefault), serverConfig),
    serverConfigPath
  };
}

function getProjectAndServerConfig(cwd, options) {
  return _objectSpread(_objectSpread({}, getProjectConfig(cwd, options)), getServerConfig(cwd, options));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb25maWcvZ2V0UHJvamVjdEFuZFNlcnZlckNvbmZpZy50cyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZVByb2plY3RDb25maWciLCJwcm9qZWN0Q29uZmlnIiwiV3BhY2tpb0Vycm9yIiwiY2hhbGsiLCJ5ZWxsb3ciLCJhcHBOYW1lIiwidGVzdCIsInJlZCIsImdyZWVuIiwiZmlsZXMiLCJBcnJheSIsImlzQXJyYXkiLCJsZW5ndGgiLCJldmVyeSIsImZpbGUiLCJuYW1lIiwiZW50cnkiLCJtYWdlbnRhIiwicGFja2FnZURpclBhdGgiLCJwYWNrYWdlRmlsZXMiLCJmIiwidmFsaWRhdGVTZXJ2ZXJDb25maWciLCJzZXJ2ZXJDb25maWciLCJwcm94eSIsImdldFByb2plY3RDb25maWciLCJjd2QiLCJvcHRpb25zIiwicHJvamVjdENvbmZpZ1BhdGgiLCJwYXRoIiwicmVzb2x2ZSIsInJlcXVpcmUiLCJlIiwiZGltIiwicHJvamVjdENvbmZpZ0RlZmF1bHQiLCJnZXRTZXJ2ZXJDb25maWciLCJzZXJ2ZXJDb25maWdQYXRoIiwic2VydmVyQ29uZmlnRGVmYXVsdCIsImdldFByb2plY3RBbmRTZXJ2ZXJDb25maWciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFFTyxTQUFTQSxxQkFBVCxDQUErQkMsYUFBL0IsRUFBc0U7QUFDNUUsTUFBSSxPQUFPQSxhQUFQLEtBQXlCLFFBQTdCLEVBQXVDO0FBQ3RDLFVBQU0sSUFBSUMsMEJBQUosQ0FDSix5RUFBd0VDLGVBQU1DLE1BQU4sQ0FDeEUsT0FBT0gsYUFEaUUsQ0FFdkUsRUFIRyxDQUFOO0FBS0EsR0FQMkUsQ0FTNUU7OztBQUNBLE1BQUksQ0FBQ0EsYUFBYSxDQUFDSSxPQUFuQixFQUE0QjtBQUMzQixVQUFNLElBQUlILDBCQUFKLENBQ0osR0FBRUMsZUFBTUMsTUFBTixDQUFhLFNBQWIsQ0FBd0IscUNBRHRC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QUEsSUFBQUEsWUFBWSxHQUFHUSxPQUFPLENBQUNLLGdCQUFELENBQXRCO0FBQ0EsR0FIRCxDQUdFLE9BQU9KLENBQVAsRUFBVTtBQUNYLFVBQU0sSUFBSTdCLDBCQUFKLENBQ0osNENBQTJDQyxlQUFNNkIsR0FBTixDQUMzQ0csZ0JBRDJDLENBRTFDLHNEQUFxRGhDLGVBQU1DLE1BQU4sQ0FDdEQsV0FEc0QsQ0FFckQsT0FBTUQsZUFBTUMsTUFBTixDQUNQLGlCQURPLENBRU4sMERBQXlERCxlQUFNYyxPQUFOLENBQ3pELEdBQUUsdUJBQVcsTUFBWCxHQUFvQixTQUFVLFlBRHlCLENBRXpELEVBVEcsQ0FBTjtBQVdBLEdBM0JBLENBNkJEOzs7QUFDQUksRUFBQUEsb0JBQW9CLENBQUNDLFlBQUQsQ0FBcEI7QUFFQSxTQUFPO0FBQ05BLElBQUFBLFlBQVksa0NBQU9jLGlDQUFQLEdBQStCZCxZQUEvQixDQUROO0FBRU5hLElBQUFBO0FBRk0sR0FBUDtBQUlBOztBQUVNLFNBQVNFLHlCQUFULENBQ05aLEdBRE0sRUFFTkMsT0FGTSxFQWFMO0FBQ0QseUNBQ0lGLGdCQUFnQixDQUFDQyxHQUFELEVBQU1DLE9BQU4sQ0FEcEIsR0FFSVEsZUFBZSxDQUFDVCxHQUFELEVBQU1DLE9BQU4sQ0FGbkI7QUFJQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjYW1lbENhc2UgZnJvbSAnY2FtZWxjYXNlJztcbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGlzWWFybiB9IGZyb20gJy4uL2Jpbi91dGlscyc7XG5pbXBvcnQgeyBXcGFja2lvRXJyb3IgfSBmcm9tICcuLi9lcnJvcnMvV3BhY2tpb0Vycm9yJztcbmltcG9ydCB7IFByb2plY3RDb25maWcsIHByb2plY3RDb25maWdEZWZhdWx0IH0gZnJvbSAnLi9wcm9qZWN0LmNvbmZpZy5kZWZhdWx0JztcbmltcG9ydCB7IFNlcnZlckNvbmZpZywgc2VydmVyQ29uZmlnRGVmYXVsdCB9IGZyb20gJy4vc2VydmVyLmNvbmZpZy5kZWZhdWx0JztcblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlUHJvamVjdENvbmZpZyhwcm9qZWN0Q29uZmlnOiBQcm9qZWN0Q29uZmlnKTogYm9vbGVhbiB7XG5cdGlmICh0eXBlb2YgcHJvamVjdENvbmZpZyAhPT0gJ29iamVjdCcpIHtcblx0XHR0aHJvdyBuZXcgV3BhY2tpb0Vycm9yKFxuXHRcdFx0YFByb2plY3QgY29uZmlndXJhdGlvbiBtdXN0IGV4cG9ydCBhbiBvYmplY3QgbGl0ZXJhbC5cXG5SaWdodCBub3cgaXQgaXMgJHtjaGFsay55ZWxsb3coXG5cdFx0XHRcdHR5cGVvZiBwcm9qZWN0Q29uZmlnXG5cdFx0XHQpfWBcblx0XHQpO1xuXHR9XG5cblx0Ly8gQ2hlY2sgaWYgdGhlIGFwcE5hbWUgaXMgb2theVxuXHRpZiAoIXByb2plY3RDb25maWcuYXBwTmFtZSkge1xuXHRcdHRocm93IG5ldyBXcGFja2lvRXJyb3IoXG5cdFx0XHRgJHtjaGFsay55ZWxsb3coJ2FwcE5hbWUnKX0gbXVzdCBiZSBwcmVzZW50IGluIHByb2plY3QgY29uZmlnLmBcblx0XHQpO1xuXHR9XG5cdGlmICghL15bQS1aYS16XSskLy50ZXN0KHByb2plY3RDb25maWcuYXBwTmFtZSkpIHtcblx0XHR0aHJvdyBuZXcgV3BhY2tpb0Vycm9yKFxuXHRcdFx0YCR7Y2hhbGsueWVsbG93KFxuXHRcdFx0XHQnYXBwTmFtZSdcblx0XHRcdCl9IG11c3QgYmUgaW4gY2FtZWxDYXNlIGluIHByb2plY3QgY29uZmlnLlxcbkN1cnJlbnRseSAke2NoYWxrLnJlZChcblx0XHRcdFx0cHJvamVjdENvbmZpZy5hcHBOYW1lXG5cdFx0XHQpfSwgdHJ5ICR7Y2hhbGsuZ3JlZW4oY2FtZWxDYXNlKHByb2plY3RDb25maWcuYXBwTmFtZSkpfWBcblx0XHQpO1xuXHR9XG5cdC8vIHZhbGlkYXRlIHJ1bnRpbWUgY29uZmlnXG5cdC8vIDEuIGlmIGZpbGVzIGlzIGludmFsaWRcblx0aWYgKCFwcm9qZWN0Q29uZmlnLmZpbGVzIHx8ICFBcnJheS5pc0FycmF5KHByb2plY3RDb25maWcuZmlsZXMpKSB7XG5cdFx0dGhyb3cgbmV3IFdwYWNraW9FcnJvcihcblx0XHRcdGAke2NoYWxrLnllbGxvdyhcblx0XHRcdFx0J2ZpbGVzJ1xuXHRcdFx0KX0gdW5kZXIgcHJvamVjdCBjb25maWd1cmF0aW9uIG11c3QgYmUgYW4gYXJyYXkuXFxuQ3VycmVudGx5IGl0IGlzICR7Y2hhbGsucmVkKFxuXHRcdFx0XHR0eXBlb2YgcHJvamVjdENvbmZpZy5maWxlc1xuXHRcdFx0KX1gXG5cdFx0KTtcblx0fVxuXHQvLyAyLiBpZiBmaWxlcyBpcyBlbXB0eVxuXHRpZiAocHJvamVjdENvbmZpZy5maWxlcy5sZW5ndGggPT09IDApIHtcblx0XHR0aHJvdyBuZXcgV3BhY2tpb0Vycm9yKFxuXHRcdFx0YCR7Y2hhbGsueWVsbG93KFxuXHRcdFx0XHQnZmlsZXMnXG5cdFx0XHQpfSB1bmRlciBwcm9qZWN0IGNvbmZpZ3VyYXRpb24gbXVzdCBoYXZlIGF0LWxlYXN0IG9uZSBvYmplY3QuYFxuXHRcdCk7XG5cdH1cblx0Ly8gMy4gdmFsaWRhdGUgZmlsZXMgYXJyYXlcblx0aWYgKFxuXHRcdCFwcm9qZWN0Q29uZmlnLmZpbGVzLmV2ZXJ5KFxuXHRcdFx0ZmlsZSA9PlxuXHRcdFx0XHR0eXBlb2YgZmlsZSA9PT0gJ29iamVjdCcgJiYgZmlsZS5uYW1lICE9IG51bGwgJiYgZmlsZS5lbnRyeSAhPSBudWxsXG5cdFx0KVxuXHQpIHtcblx0XHR0aHJvdyBuZXcgV3BhY2tpb0Vycm9yKFxuXHRcdFx0YCR7Y2hhbGsueWVsbG93KFxuXHRcdFx0XHQnZmlsZXMnXG5cdFx0XHQpfSB1bmRlciBwcm9qZWN0IGNvbmZpZ3VyYXRpb24gbXVzdCBoYXZlIG9iamVjdHMgd2l0aFxcbiR7Y2hhbGsubWFnZW50YShcblx0XHRcdFx0J25hbWUnXG5cdFx0XHQpfSBhbmQgJHtjaGFsay5tYWdlbnRhKFxuXHRcdFx0XHQnZW50cnknXG5cdFx0XHQpfS5cXG5BdC1sZWFzdCBvbmUgb2YgdGhlIG9iamVjdHMgZG9lcyBub3Qgc2F0aXNmeSB0aGUgY29uZGl0aW9uLmBcblx0XHQpO1xuXHR9XG5cdC8vIDQuIFZhbGlkYXRlIHBhY2thZ2UgY29uZmlnc1xuXHRpZiAoIXByb2plY3RDb25maWcucGFja2FnZURpclBhdGggfHwgcHJvamVjdENvbmZpZy5wYWNrYWdlRGlyUGF0aCA9PT0gJycpIHtcblx0XHR0aHJvdyBuZXcgV3BhY2tpb0Vycm9yKFxuXHRcdFx0YCR7Y2hhbGsueWVsbG93KFxuXHRcdFx0XHQncGFja2FnZURpclBhdGgnXG5cdFx0XHQpfSB1bmRlciBwcm9qZWN0IGNvbmZpZ3VyYXRpb24gbXVzdCBiZSB2YWxpZC5cXG5JdCBkZWZpbmVzIHRoZSBwYXRoIHRvIHBhY2thZ2Ugb3V0cHV0IGRpcmVjdG9yeS5gXG5cdFx0KTtcblx0fVxuXHRpZiAoXG5cdFx0IXByb2plY3RDb25maWcucGFja2FnZUZpbGVzIHx8XG5cdFx0IUFycmF5LmlzQXJyYXkocHJvamVjdENvbmZpZy5wYWNrYWdlRmlsZXMpIHx8XG5cdFx0IXByb2plY3RDb25maWcucGFja2FnZUZpbGVzLmxlbmd0aCB8fFxuXHRcdCFwcm9qZWN0Q29uZmlnLnBhY2thZ2VGaWxlcy5ldmVyeShmID0+IHR5cGVvZiBmID09PSAnc3RyaW5nJylcblx0KSB7XG5cdFx0dGhyb3cgbmV3IFdwYWNraW9FcnJvcihcblx0XHRcdGAke2NoYWxrLnllbGxvdyhcblx0XHRcdFx0J3BhY2thZ2VGaWxlcydcblx0XHRcdCl9IHVuZGVyIHByb2plY3QgY29uZmlndXJhdGlvbiBtdXN0IGJlIHZhbGlkIGdsb2IgcGF0dGVybnMuYFxuXHRcdCk7XG5cdH1cblx0cmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVNlcnZlckNvbmZpZyhzZXJ2ZXJDb25maWc6IFNlcnZlckNvbmZpZyk6IGJvb2xlYW4ge1xuXHRpZiAodHlwZW9mIHNlcnZlckNvbmZpZyAhPT0gJ29iamVjdCcpIHtcblx0XHR0aHJvdyBuZXcgV3BhY2tpb0Vycm9yKFxuXHRcdFx0YFNlcnZlciBjb25maWd1cmF0aW9uIG11c3QgZXhwb3J0IGFuIG9iamVjdCBsaXRlcmFsLlxcblJpZ2h0IG5vdyBpdCBpcyAke2NoYWxrLnllbGxvdyhcblx0XHRcdFx0dHlwZW9mIHNlcnZlckNvbmZpZ1xuXHRcdFx0KX1gXG5cdFx0KTtcblx0fVxuXHQvLyBDaGVjayBpZiBzZXJ2ZXIgY29uZmlnIGhhcyBwcm94eVxuXHRpZiAoIXNlcnZlckNvbmZpZy5wcm94eSB8fCBzZXJ2ZXJDb25maWcucHJveHkgPT09ICcnKSB7XG5cdFx0dGhyb3cgbmV3IFdwYWNraW9FcnJvcihcblx0XHRcdGAke2NoYWxrLnllbGxvdyhcblx0XHRcdFx0J3Byb3h5J1xuXHRcdFx0KX0gdW5kZXIgc2VydmVyIGNvbmZpZ3VyYXRpb24gbXVzdCBiZSBhbiBVUkwgdG8geW91ciBkZXZlbG9wbWVudCBzZXJ2ZXIuYFxuXHRcdCk7XG5cdH1cblx0cmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcm9qZWN0Q29uZmlnKFxuXHRjd2Q6IHN0cmluZyxcblx0b3B0aW9ucz86XG5cdFx0fCB7XG5cdFx0XHRcdHByb2plY3RDb25maWc/OiBzdHJpbmc7XG5cdFx0ICB9XG5cdFx0fCB1bmRlZmluZWRcbik6IHtcblx0cHJvamVjdENvbmZpZzogUHJvamVjdENvbmZpZztcblx0cHJvamVjdENvbmZpZ1BhdGg6IHN0cmluZztcbn0ge1xuXHRjb25zdCBwcm9qZWN0Q29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZShcblx0XHRjd2QsXG5cdFx0b3B0aW9ucyAmJiBvcHRpb25zLnByb2plY3RDb25maWdcblx0XHRcdD8gb3B0aW9ucy5wcm9qZWN0Q29uZmlnXG5cdFx0XHQ6ICd3cGFja2lvLnByb2plY3QuanMnXG5cdCk7XG5cblx0bGV0IHByb2plY3RDb25maWc6IFByb2plY3RDb25maWc7XG5cblx0Ly8gRmlyc3QgY2hlY2sgdG8gc2VlIGlmIHRoZSBmaWxlcyBhcmUgcHJlc2VudFxuXHR0cnkge1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBnbG9iYWwtcmVxdWlyZSwgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xuXHRcdHByb2plY3RDb25maWcgPSByZXF1aXJlKHByb2plY3RDb25maWdQYXRoKSBhcyBQcm9qZWN0Q29uZmlnO1xuXHR9IGNhdGNoIChlKSB7XG5cdFx0dGhyb3cgbmV3IFdwYWNraW9FcnJvcihcblx0XHRcdGBDb3VsZCBub3QgZmluZCBwcm9qZWN0IGNvbmZpZ3VyYXRpb24gYXQ6XFxuJHtjaGFsay5kaW0oXG5cdFx0XHRcdHByb2plY3RDb25maWdQYXRoXG5cdFx0XHQpfVxcblBsZWFzZSBtYWtlIHN1cmUgdGhlIGZpbGUgZXhpc3RzXFxub3IgYWRqdXN0IHlvdXIgJHtjaGFsay55ZWxsb3coXG5cdFx0XHRcdCctLWNvbnRleHQnXG5cdFx0XHQpfSBvciAke2NoYWxrLnllbGxvdyhcblx0XHRcdFx0Jy0tcHJvamVjdC1jb25maWcnXG5cdFx0XHQpfSBwYXJhbWV0ZXJzLlxcbklmIHRoaXMgaXMgeW91ciBmaXJzdCB0aW1lLCB0cnkgcnVubmluZ1xcbiR7Y2hhbGsubWFnZW50YShcblx0XHRcdFx0YCR7aXNZYXJuKCkgPyAneWFybicgOiAnbnBtIHJ1bid9IGJvb3RzdHJhcGBcblx0XHRcdCl9YFxuXHRcdCk7XG5cdH1cblxuXHQvLyBOb3cgdmFsaWRhdGUgdGhlbVxuXHR2YWxpZGF0ZVByb2plY3RDb25maWcocHJvamVjdENvbmZpZyk7XG5cblx0cmV0dXJuIHtcblx0XHRwcm9qZWN0Q29uZmlnOiB7IC4uLnByb2plY3RDb25maWdEZWZhdWx0LCAuLi5wcm9qZWN0Q29uZmlnIH0sXG5cdFx0cHJvamVjdENvbmZpZ1BhdGgsXG5cdH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRTZXJ2ZXJDb25maWcoXG5cdGN3ZDogc3RyaW5nLFxuXHRvcHRpb25zPzpcblx0XHR8IHtcblx0XHRcdFx0c2VydmVyQ29uZmlnPzogc3RyaW5nO1xuXHRcdCAgfVxuXHRcdHwgdW5kZWZpbmVkXG4pOiB7XG5cdHNlcnZlckNvbmZpZzogU2VydmVyQ29uZmlnO1xuXHRzZXJ2ZXJDb25maWdQYXRoOiBzdHJpbmc7XG59IHtcblx0Ly8gR2V0IHRoZSBjb25maWcgZmlsZSBwYXRocyBmcm9tIG9wdGlvbnNcblx0Ly8gSWYgdXNlciBpcyBwYXNzaW5nIHJlbGF0aXZlIHBhdGgsIHRoZW4gaXQgd2lsbCBiZSB1c2VkIGFsb25nIHdpdGggY3dkXG5cdC8vIElmIGl0IGlzIGFic29sdXRlIHBhdGgsIHRoZW4gdGhlIGFic29sdXRlIHdvdWxkIGJlIHVzZWQgaW5zdGVhZFxuXHQvLyBUaGlzIGlzIGhvdyBwYXRoLnJlc29sdmUgd29ya3MuXG5cdGNvbnN0IHNlcnZlckNvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUoXG5cdFx0Y3dkLFxuXHRcdG9wdGlvbnMgJiYgb3B0aW9ucy5zZXJ2ZXJDb25maWcgPyBvcHRpb25zLnNlcnZlckNvbmZpZyA6ICd3cGFja2lvLnNlcnZlci5qcydcblx0KTtcblx0Ly8gTm93IGNyZWF0ZSB0aGUgY29uZmlndXJhdGlvbiBvYmplY3RzXG5cdGxldCBzZXJ2ZXJDb25maWc6IFNlcnZlckNvbmZpZztcblxuXHR0cnkge1xuXHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBnbG9iYWwtcmVxdWlyZSwgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xuXHRcdHNlcnZlckNvbmZpZyA9IHJlcXVpcmUoc2VydmVyQ29uZmlnUGF0aCkgYXMgU2VydmVyQ29uZmlnO1xuXHR9IGNhdGNoIChlKSB7XG5cdFx0dGhyb3cgbmV3IFdwYWNraW9FcnJvcihcblx0XHRcdGBDb3VsZCBub3QgZmluZCBzZXJ2ZXIgY29uZmlndXJhdGlvbiBhdDpcXG4ke2NoYWxrLmRpbShcblx0XHRcdFx0c2VydmVyQ29uZmlnUGF0aFxuXHRcdFx0KX1cXG5QbGVhc2UgbWFrZSBzdXJlIHRoZSBmaWxlIGV4aXN0c1xcbm9yIGFkanVzdCB5b3VyICR7Y2hhbGsueWVsbG93KFxuXHRcdFx0XHQnLS1jb250ZXh0J1xuXHRcdFx0KX0gb3IgJHtjaGFsay55ZWxsb3coXG5cdFx0XHRcdCctLXNlcnZlci1jb25maWcnXG5cdFx0XHQpfSBwYXJhbWV0ZXJzLlxcbklmIHRoaXMgaXMgeW91ciBmaXJzdCB0aW1lLCB0cnkgcnVubmluZ1xcbiR7Y2hhbGsubWFnZW50YShcblx0XHRcdFx0YCR7aXNZYXJuKCkgPyAneWFybicgOiAnbnBtIHJ1bid9IGJvb3RzdHJhcGBcblx0XHRcdCl9YFxuXHRcdCk7XG5cdH1cblxuXHQvLyBWYWxpZGF0ZSB0aGVtXG5cdHZhbGlkYXRlU2VydmVyQ29uZmlnKHNlcnZlckNvbmZpZyk7XG5cblx0cmV0dXJuIHtcblx0XHRzZXJ2ZXJDb25maWc6IHsgLi4uc2VydmVyQ29uZmlnRGVmYXVsdCwgLi4uc2VydmVyQ29uZmlnIH0sXG5cdFx0c2VydmVyQ29uZmlnUGF0aCxcblx0fTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFByb2plY3RBbmRTZXJ2ZXJDb25maWcoXG5cdGN3ZDogc3RyaW5nLFxuXHRvcHRpb25zPzpcblx0XHR8IHtcblx0XHRcdFx0cHJvamVjdENvbmZpZz86IHN0cmluZztcblx0XHRcdFx0c2VydmVyQ29uZmlnPzogc3RyaW5nO1xuXHRcdCAgfVxuXHRcdHwgdW5kZWZpbmVkXG4pOiB7XG5cdHByb2plY3RDb25maWc6IFByb2plY3RDb25maWc7XG5cdHNlcnZlckNvbmZpZzogU2VydmVyQ29uZmlnO1xuXHRwcm9qZWN0Q29uZmlnUGF0aDogc3RyaW5nO1xuXHRzZXJ2ZXJDb25maWdQYXRoOiBzdHJpbmc7XG59IHtcblx0cmV0dXJuIHtcblx0XHQuLi5nZXRQcm9qZWN0Q29uZmlnKGN3ZCwgb3B0aW9ucyksXG5cdFx0Li4uZ2V0U2VydmVyQ29uZmlnKGN3ZCwgb3B0aW9ucyksXG5cdH07XG59XG4iXX0=